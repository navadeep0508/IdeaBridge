{% extends "base.html" %}

{% block content %}
<!-- Header -->
<section style="background: linear-gradient(135deg, #E3EFD3 0%, #ffffff 100%); padding: 60px 0 40px;">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="fw-bold mb-2" style="color: #0D2B1D;">
          <i class='bx bx-envelope me-3'></i>Messages
        </h1>
        <p class="text-muted mb-0">Connect with entrepreneurs and investors</p>
      </div>
    </div>
  </div>
</section>

<!-- Messages Content -->
<section style="padding: 60px 0; background: white;">
  <div class="container">
    <div class="row">
      <!-- Tabs -->
      <div class="col-12 mb-4">
        <ul class="nav nav-pills" style="background: #E3EFD3; padding: 8px; border-radius: 50px;">
          <li class="nav-item flex-fill">
            <a class="nav-link active text-center" data-bs-toggle="pill" href="#inbox" style="border-radius: 50px; font-weight: 600;">
              <i class='bx bx-inbox me-2'></i>Inbox ({{ received|length }})
            </a>
          </li>
          <li class="nav-item flex-fill">
            <a class="nav-link text-center" data-bs-toggle="pill" href="#sent" style="border-radius: 50px; font-weight: 600;">
              <i class='bx bx-send me-2'></i>Sent ({{ sent|length }})
            </a>
          </li>
        </ul>
      </div>
      
      <!-- Tab Content -->
      <div class="col-12">
        <div class="tab-content">
          <!-- Inbox -->
          <div class="tab-pane fade show active" id="inbox">
            {% if received %}
            <div class="row g-3">
              {% for msg in received %}
              <div class="col-12">
                <div class="card border-0" style="border-radius: 16px; box-shadow: 0 4px 20px rgba(13, 43, 29, 0.08); {% if not msg.is_read %}border-left: 4px solid #345635;{% endif %}">
                  <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                      <div class="d-flex align-items-center">
                        <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #345635, #6B8F71); display: flex; align-items: center; justify-content: center; margin-right: 16px;">
                          <span class="fw-bold" style="color: white; font-size: 1.2rem;">{{ msg.sender_name[0].upper() }}</span>
                        </div>
                        <div>
                          <h6 class="mb-0 fw-bold" style="color: #0D2B1D;">{{ msg.sender_name }}</h6>
                          <small class="text-muted">
                            <i class='bx bx-time-five me-1'></i>{{ msg.created_at[:16] }}
                          </small>
                        </div>
                      </div>
                      {% if not msg.is_read %}
                      <span class="badge px-3 py-2" style="background: #345635; color: white; border-radius: 8px;">New</span>
                      {% endif %}
                    </div>
                    {% if msg.subject %}
                    <h6 class="fw-bold mb-2" style="color: #0D2B1D;">{{ msg.subject }}</h6>
                    {% endif %}
                    <p class="mb-3" style="color: #6B8F71;">{{ msg.content[:150] }}{% if msg.content|length > 150 %}...{% endif %}</p>
                    <div class="d-flex gap-2">
                      <a href="{{ url_for('send_message', user_id=msg.sender_id) }}" class="btn btn-sm px-4 py-2" style="background: linear-gradient(135deg, #345635, #6B8F71); color: white; border: none; border-radius: 50px; font-weight: 600;">
                        <i class='bx bx-reply me-2'></i>Reply
                      </a>
                      {% if not msg.is_read %}
                      <button onclick="markRead({{ msg.id }})" class="btn btn-sm px-4 py-2" style="background: white; color: #345635; border: 2px solid #AEC3B0; border-radius: 50px; font-weight: 600;">
                        <i class='bx bx-check me-2'></i>Mark Read
                      </button>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
              <i class='bx bx-inbox' style="font-size: 4rem; color: #AEC3B0;"></i>
              <h4 class="mt-3 mb-2" style="color: #0D2B1D;">No messages yet</h4>
              <p class="text-muted">Your inbox is empty</p>
            </div>
            {% endif %}
          </div>
          
          <!-- Sent -->
          <div class="tab-pane fade" id="sent">
            {% if sent %}
            <div class="row g-3">
              {% for msg in sent %}
              <div class="col-12">
                <div class="card border-0" style="border-radius: 16px; box-shadow: 0 4px 20px rgba(13, 43, 29, 0.08);">
                  <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                      <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #6B8F71, #AEC3B0); display: flex; align-items: center; justify-content: center; margin-right: 16px;">
                        <span class="fw-bold" style="color: white; font-size: 1.2rem;">{{ msg.receiver_name[0].upper() }}</span>
                      </div>
                      <div>
                        <h6 class="mb-0 fw-bold" style="color: #0D2B1D;">To: {{ msg.receiver_name }}</h6>
                        <small class="text-muted">
                          <i class='bx bx-time-five me-1'></i>{{ msg.created_at[:16] }}
                        </small>
                      </div>
                    </div>
                    {% if msg.subject %}
                    <h6 class="fw-bold mb-2" style="color: #0D2B1D;">{{ msg.subject }}</h6>
                    {% endif %}
                    <p class="mb-0" style="color: #6B8F71;">{{ msg.content[:150] }}{% if msg.content|length > 150 %}...{% endif %}</p>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
              <i class='bx bx-send' style="font-size: 4rem; color: #AEC3B0;"></i>
              <h4 class="mt-3 mb-2" style="color: #0D2B1D;">No sent messages</h4>
              <p class="text-muted">You haven't sent any messages yet</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
async function markRead(messageId) {
  const response = await fetch(`/message/${messageId}/read`, { method: 'POST' });
  if (response.ok) {
    location.reload();
  }
}
</script>

<style>
.nav-pills .nav-link {
  color: #345635;
}
.nav-pills .nav-link.active {
  background: linear-gradient(135deg, #345635, #6B8F71);
  color: white;
}
</style>
{% endblock %}
