{% extends "base.html" %}

{% block content %}
<!-- Breadcrumb -->
<div class="container" style="padding-top: 30px;">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb" style="background: transparent;">
      <li class="breadcrumb-item"><a href="{{ url_for('index') }}" style="color: #6B8F71;">Home</a></li>
      <li class="breadcrumb-item active" style="color: #0D2B1D;">{{ p['title'][:50] }}{% if p['title']|length > 50 %}...{% endif %}</li>
    </ol>
  </nav>
</div>

<!-- Main Content -->
<section style="padding: 40px 0 80px; background: white;">
  <div class="container">
    <div class="row g-4">
      <!-- Main Pitch Content -->
      <div class="col-lg-8">
        <!-- Pitch Card -->
        <div class="card border-0" style="border-radius: 24px; overflow: hidden; box-shadow: 0 8px 32px rgba(13, 43, 29, 0.1);">
          <!-- Image Header -->
          {% if p.image and p.image != 'None' %}
          <div style="height: 400px; overflow: hidden; background: linear-gradient(135deg, #E3EFD3 0%, #AEC3B0 100%);">
            <img src="{{ url_for('static', filename='uploads/' + p.image) }}" alt="{{ p['title'] }}" style="width: 100%; height: 100%; object-fit: cover;">
          </div>
          {% else %}
          <div style="height: 300px; background: linear-gradient(135deg, #345635 0%, #6B8F71 100%); display: flex; align-items: center; justify-content: center;">
            <i class='bx bx-bulb' style="font-size: 6rem; color: white; opacity: 0.3;"></i>
          </div>
          {% endif %}
          
          <!-- Content -->
          <div class="card-body p-5">
            <!-- Category & Date -->
            <div class="d-flex align-items-center mb-3">
              {% if p.category %}
              <span class="badge px-3 py-2 me-3" style="background: #E3EFD3; color: #345635; border-radius: 8px;">{{ p.category.replace('-', ' ').title() }}</span>
              {% endif %}
              <small class="text-muted">
                <i class='bx bx-calendar me-1'></i>{{ p['created_at'][:10] if p['created_at'] }}
              </small>
            </div>
            
            <!-- Title -->
            <h1 class="fw-bold mb-4" style="color: #0D2B1D; font-size: 2.5rem; line-height: 1.3;">{{ p['title'] }}</h1>
            
            <!-- Summary -->
            {% if p['summary'] %}
            <div class="p-4 mb-4" style="background: #E3EFD3; border-radius: 16px; border-left: 4px solid #345635;">
              <p class="lead mb-0" style="color: #0D2B1D; font-size: 1.2rem; line-height: 1.8;">{{ p['summary'] }}</p>
            </div>
            {% endif %}
            
            <!-- Full Content -->
            <div style="line-height: 1.9; font-size: 1.1rem; color: #0D2B1D;">
              {{ p['content'] | replace('\n', '<br>') | safe }}
            </div>
            
            <!-- Additional Info -->
            {% if p.funding_goal or p.stage or p.team_size or p.location %}
            <div class="mt-5 pt-4" style="border-top: 2px solid #E3EFD3;">
              <h4 class="fw-bold mb-4" style="color: #0D2B1D;">Additional Details</h4>
              <div class="row g-3">
                {% if p.funding_goal %}
                <div class="col-md-6">
                  <div class="p-3" style="background: #E3EFD3; border-radius: 12px;">
                    <small class="text-muted d-block mb-1">Funding Goal</small>
                    <p class="mb-0 fw-bold" style="color: #345635; font-size: 1.1rem;">${{ p.funding_goal }}</p>
                  </div>
                </div>
                {% endif %}
                {% if p.stage %}
                <div class="col-md-6">
                  <div class="p-3" style="background: #E3EFD3; border-radius: 12px;">
                    <small class="text-muted d-block mb-1">Stage</small>
                    <p class="mb-0 fw-bold" style="color: #345635; font-size: 1.1rem;">{{ p.stage.title() }}</p>
                  </div>
                </div>
                {% endif %}
                {% if p.team_size %}
                <div class="col-md-6">
                  <div class="p-3" style="background: #E3EFD3; border-radius: 12px;">
                    <small class="text-muted d-block mb-1">Team Size</small>
                    <p class="mb-0 fw-bold" style="color: #345635; font-size: 1.1rem;">{{ p.team_size }}</p>
                  </div>
                </div>
                {% endif %}
                {% if p.location %}
                <div class="col-md-6">
                  <div class="p-3" style="background: #E3EFD3; border-radius: 12px;">
                    <small class="text-muted d-block mb-1">Location</small>
                    <p class="mb-0 fw-bold" style="color: #345635; font-size: 1.1rem;">{{ p.location }}</p>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}
            
            <!-- Links -->
            {% if p.website or p.demo_url %}
            <div class="mt-4 d-flex gap-3">
              {% if p.website %}
              <a href="{{ p.website }}" target="_blank" class="btn px-4 py-2" style="background: white; color: #345635; border: 2px solid #345635; border-radius: 50px; font-weight: 600;">
                <i class='bx bx-link me-2'></i>Website
              </a>
              {% endif %}
              {% if p.demo_url %}
              <a href="{{ p.demo_url }}" target="_blank" class="btn px-4 py-2" style="background: white; color: #345635; border: 2px solid #345635; border-radius: 50px; font-weight: 600;">
                <i class='bx bx-video me-2'></i>Demo
              </a>
              {% endif %}
            </div>
            {% endif %}
          </div>
          
          <!-- Interaction Bar -->
          <div class="card-footer p-4" style="background: #E3EFD3; border-top: none;">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex gap-3">
                <!-- Like Button -->
                {% if session.get('user_id') %}
                <form action="{{ url_for('like_pitch', pitch_id=p['id']) }}" method="POST" style="display: inline;" id="likeForm">
                  <button type="submit" class="btn px-4 py-2" style="background: {% if user_liked %}linear-gradient(135deg, #345635, #6B8F71){% else %}white{% endif %}; color: {% if user_liked %}white{% else %}#345635{% endif %}; border: 2px solid #345635; border-radius: 50px; font-weight: 600;">
                    <i class='bx {% if user_liked %}bxs-heart{% else %}bx-heart{% endif %} me-2'></i><span id="likeCount">{{ like_count }}</span> Likes
                  </button>
                </form>
                {% else %}
                <span class="btn px-4 py-2" style="background: white; color: #345635; border: 2px solid #345635; border-radius: 50px; font-weight: 600;">
                  <i class='bx bx-heart me-2'></i>{{ like_count }} Likes
                </span>
                {% endif %}
                
                <!-- Comment Count -->
                <span class="btn px-4 py-2" style="background: white; color: #345635; border: 2px solid #345635; border-radius: 50px; font-weight: 600;">
                  <i class='bx bx-comment me-2'></i>{{ comments|length }} Comments
                </span>
              </div>
              
              <a href="{{ url_for('index') }}" class="btn px-4 py-2" style="background: white; color: #6B8F71; border: 2px solid #AEC3B0; border-radius: 50px; font-weight: 600;">
                <i class='bx bx-arrow-back me-2'></i>Back
              </a>
            </div>
          </div>
        </div>
        
        <!-- Comments Section -->
        <div class="card border-0 mt-4" style="border-radius: 24px; box-shadow: 0 4px 20px rgba(13, 43, 29, 0.08);">
          <div class="card-body p-5">
            <h4 class="fw-bold mb-4" style="color: #0D2B1D;">
              <i class='bx bx-comment-dots me-2'></i>Comments ({{ comments|length }})
            </h4>
            
            <!-- Add Comment Form -->
            {% if session.get('user_id') %}
            <form action="{{ url_for('add_comment', pitch_id=p['id']) }}" method="POST" class="mb-5">
              <div class="mb-3">
                <textarea name="content" class="form-control" rows="3" placeholder="Share your thoughts..." required style="border-radius: 12px; border: 2px solid #AEC3B0;"></textarea>
              </div>
              <button type="submit" class="btn px-4 py-2" style="background: linear-gradient(135deg, #345635, #6B8F71); color: white; border: none; border-radius: 50px; font-weight: 600;">
                <i class='bx bx-send me-2'></i>Post Comment
              </button>
            </form>
            {% else %}
            <div class="alert mb-4" style="background: #E3EFD3; border: none; border-radius: 12px;">
              <a href="{{ url_for('login') }}" style="color: #345635; font-weight: 600;">Login</a> to leave a comment
            </div>
            {% endif %}
            
            <!-- Comments List -->
            {% if comments %}
            <div class="comments-list">
              {% for comment in comments %}
              <div class="d-flex mb-4 pb-4" style="border-bottom: 1px solid #E3EFD3;">
                <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #6B8F71, #AEC3B0); display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-right: 16px;">
                  <span class="fw-bold" style="color: white; font-size: 1.2rem;">{{ comment['username'][0].upper() }}</span>
                </div>
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <h6 class="mb-0 fw-bold" style="color: #0D2B1D;">{{ comment['username'] }}</h6>
                      <small class="text-muted">
                        <i class='bx bx-time-five me-1'></i>{{ comment['created_at'][:16] }}
                      </small>
                    </div>
                    {% if session.get('user_id') == comment['user_id'] %}
                    <form action="{{ url_for('delete_comment', comment_id=comment['id']) }}" method="POST" style="display: inline;">
                      <button type="submit" class="btn btn-sm" style="color: #C9A961;" onclick="return confirm('Delete this comment?')">
                        <i class='bx bx-trash'></i>
                      </button>
                    </form>
                    {% endif %}
                  </div>
                  <p class="mb-0" style="color: #0D2B1D; line-height: 1.6;">{{ comment['content'] }}</p>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-4">
              <i class='bx bx-comment' style="font-size: 3rem; color: #AEC3B0;"></i>
              <p class="text-muted mt-2">No comments yet. Be the first to comment!</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      
      <!-- Sidebar -->
      <div class="col-lg-4">
        <!-- Author Card -->
        <div class="card border-0 mb-4" style="border-radius: 20px; box-shadow: 0 4px 20px rgba(13, 43, 29, 0.08);">
          <div class="card-body p-4">
            <h5 class="fw-bold mb-4" style="color: #0D2B1D;">
              <i class='bx bx-user me-2'></i>About the Creator
            </h5>
            <div class="text-center mb-4">
              <div class="d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px; background: linear-gradient(135deg, #345635, #6B8F71); border-radius: 50%;">
                <span class="fw-bold" style="font-size: 2rem; color: white;">{{ p['username'][0].upper() }}</span>
              </div>
              <h6 class="fw-bold mb-1" style="color: #0D2B1D;">{{ p['username'] }}</h6>
              <small class="text-muted">Entrepreneur</small>
            </div>
            
            {% if session.get('user_id') and session.get('user_id') != p['author_user_id'] %}
            <div class="d-grid">
              <a href="{{ url_for('send_message', user_id=p['author_user_id']) }}" class="btn py-2 mb-2" style="background: linear-gradient(135deg, #345635, #6B8F71); color: white; border: none; border-radius: 12px; font-weight: 600;">
                <i class='bx bx-envelope me-2'></i>Send Message
              </a>
            </div>
            {% endif %}
          </div>
        </div>
        
        <!-- Looking For -->
        {% if p.looking_for %}
        <div class="card border-0" style="border-radius: 20px; box-shadow: 0 4px 20px rgba(13, 43, 29, 0.08);">
          <div class="card-body p-4">
            <h5 class="fw-bold mb-3" style="color: #0D2B1D;">
              <i class='bx bx-search me-2'></i>Looking For
            </h5>
            <div class="d-flex flex-wrap gap-2">
              {% for item in p.looking_for.split(',') %}
              <span class="badge px-3 py-2" style="background: #E3EFD3; color: #345635; border-radius: 8px; font-size: 0.85rem;">{{ item.title() }}</span>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<script>
// Handle like button with AJAX
document.getElementById('likeForm')?.addEventListener('submit', async function(e) {
  e.preventDefault();
  const response = await fetch(this.action, { method: 'POST' });
  const data = await response.json();
  if (data.success) {
    document.getElementById('likeCount').textContent = data.like_count;
    const btn = this.querySelector('button');
    const icon = btn.querySelector('i');
    if (data.liked) {
      btn.style.background = 'linear-gradient(135deg, #345635, #6B8F71)';
      btn.style.color = 'white';
      icon.classList.remove('bx-heart');
      icon.classList.add('bxs-heart');
    } else {
      btn.style.background = 'white';
      btn.style.color = '#345635';
      icon.classList.remove('bxs-heart');
      icon.classList.add('bx-heart');
    }
  }
});
</script>
{% endblock %}